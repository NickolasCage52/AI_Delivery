# Fix: 404 на Next.js static chunks

## Симптомы

- При загрузке страницы в консоли/сети 404 на:
  - `/_next/static/chunks/app-pages-internals.js`
  - `/_next/static/chunks/main-app.js`
  - `/_next/static/chunks/app/page.js`
- Стили не применяются (голый HTML), гидрации нет.

---

## Причина

1. **Имена без хеша**  
   В production Next.js 15 генерирует **хешированные** имена чанков, например:
   - `main-app-2a38320a4862035f.js`
   - `app/page-1fd06dfe2d95d001.js`  
   В `index.html` после `next build` подключаются именно такие пути. Пути без хеша (`main-app.js`, `app/page.js`) в текущей сборке **не используются**.

2. **Откуда тогда берутся 404 по старым путям**
   - Кэш браузера или CDN: отдаётся старый HTML со старыми путями к чанкам.
   - Прокси/nginx отдают другой `index.html` (не от Next) или режут `/_next/*`.
   - Раньше был другой `basePath`/`assetPrefix` — HTML собирался с префиксом, а сейчас запросы идут без него (или наоборот).
   - В dev (`next dev`) возможны кратковременные 404 при первой загрузке чанков (известное поведение).

3. **Middleware**  
   Если middleware вызывается для `/_next/static/*` и делает redirect/rewrite/ответ без передачи в Next, статика не доходит до приложения и получаются 404.

---

## Что проверено в проекте

| Проверка | Результат |
|----------|-----------|
| `next.config.ts` | Нет `basePath`, `assetPrefix`, `output: "export"` — конфиг без лишнего. |
| `middleware.ts` | В проекте не было; добавлен `middleware.ts` с **matcher**, который **исключает** `_next/static`, `_next/image`, `favicon.ico` — эти запросы middleware не обрабатывает. |
| `app/layout.tsx` | Подключён `import "./globals.css"` — корректно. |
| Сборка | После `next build` в `.next/static/chunks/` есть хешированные файлы: `main-app-*.js`, `app/page-*.js`, `app/layout-*.js`, CSS в `.next/static/css/`. |
| HTML | В `.next/server/app/index.html` в script/src указаны именно хешированные пути. |

Итог: сборка и конфиг в порядке; 404 по путям без хеша означают, что браузер получает не тот HTML или что-то перехватывает запросы к `/_next/*`.

---

## Внесённые изменения

1. **`middleware.ts`** (новый)
   - Один обработчик: `NextResponse.next()`.
   - `config.matcher` настроен так, чтобы middleware **не выполнялся** для:
     - `/_next/static`
     - `/_next/image`
     - `favicon.ico`
     - типичных статических расширений (svg, png, jpg и т.д.)
   - Цель: при добавлении в будущем логики (редиректы, auth) запросы к чанкам и статике не будут перехватываться и не приведут к 404.

2. **`next.config.ts`**  
   Добавлены заголовки кэширования для `/_next/static/*`: `Cache-Control: public, max-age=31536000, immutable`. Чанки с хешем в имени можно кэшировать надолго; при новом деплое новые хеши гарантируют загрузку актуальных файлов.

---

## Как проверить

1. **Чистая сборка и запуск**
   ```bash
   # В корне проекта (Windows PowerShell)
   Remove-Item -Recurse -Force .next -ErrorAction SilentlyContinue
   npm run build
   npm run start
   ```
   Важно: `npm run start` должен запускаться **после** успешного `npm run build` — он раздаёт содержимое папки `.next`. Без свежей сборки возможны 404 или устаревшая версия.  
   Открыть в браузере (лучше в режиме инкогнито или с отключённым кэшем) `http://localhost:3000`.

2. **Проверка чанков**
   - После `npm run build` в папке `.next/static/chunks/` должны быть файлы вида:
     - `main-app-<hash>.js`
     - `app/page-<hash>.js`
     - `app/layout-<hash>.js`
   - В DevTools → Network при загрузке страницы запросы к `/_next/static/chunks/...` и `/_next/static/css/...` должны возвращать **200**, не 404.

3. **Гидрация и стили**
   - Стили Tailwind применяются (фон, типографика).
   - Нет сообщений про failed to load script в консоли.
   - Интерактивность работает (кнопки, форма, навигация).

4. **Если сайт за прокси/nginx**
   - Убедиться, что запросы к `/_next/*` и `/_next/static/*` проксируются на тот же хост/порт, где работает `next start` (или Node-сервер приложения).
   - Не отдавать свой статический `index.html` вместо ответа от Next.

5. **Кэш**
   - При повторных 404: жёсткое обновление (Ctrl+Shift+R) или очистка кэша для сайта.
   - Если используется CDN — сбросить кэш для HTML и при необходимости для `/_next/*`.

---

## Если сборка падает с EPERM (Windows)

Ошибка `Error: spawn EPERM` при `npm run build` часто связана с окружением:

- **OneDrive / синхронизация**: папка проекта в OneDrive может блокировать создание процессов. Соберите проект из локальной папки вне облака (например `C:\dev\ai-delivery`).
- **Антивирус**: временно отключите проверку папки проекта или добавьте исключение для `node_modules` и `.next`.
- **Права**: запустите терминал от имени администратора или проверьте, что папка не только для чтения.
- **Чистая пересборка**: удалите `.next` и `node_modules`, затем снова выполните `npm install` и `npm run build`.

После этого `npm run build` и `npm run start` должны выполняться без 404 на `/_next/static/*`.

---

## Кратко

- **Причина 404**: браузер запрашивает старые пути к чанкам (без хеша) из-за кэша, другого HTML или перехвата `/_next/*`; в актуальной сборке используются только хешированные имена.
- **Что сделано**: добавлен `middleware.ts` с matcher, исключающим `_next/static`, `_next/image` и статику; в `next.config.ts` — заголовки кэша для `/_next/static/*` (immutable).
- **Проверка**: удалить `.next`, выполнить `npm run build` и `npm run start`, открыть сайт без кэша и убедиться, что запросы к `/_next/static/*` и CSS возвращают 200, стили и гидрация работают.
